# 1.4. 访问令牌

访问令牌是用于访问受保护资源的凭据，是代表了颁发给客户端的授权的字符串。

即使这一字符串具有某种结构，它也被视为对客户端不透明。客户端**禁止**期望能够解析访问令牌的值。授权服务器不必采用某种一致的访问令牌编码或格式，除了需要满足资源服务器的期望。

访问令牌代表了特定的访问范围和访问持续时间。这种范围和时间由资源所有者授予许可，并由资源服务器和授权服务器执行。

根据授权服务器的具体实现，令牌字符串可能被资源服务器用来获取授权信息，或者其本身就以某种可验证的方式包含了这些授权信息（例如包含了已签名的数据负载的令牌字符串）。令牌检查 [[RFC7662](https://www.rfc-editor.org/info/rfc7662)] 是令牌获取机制的一个示例。在该机制中，资源服务器访问授权服务器的某个端点，来验证客户端展示的令牌。访问令牌的 JWT 形式 [[RFC9068](https://www.rfc-editor.org/info/rfc9068)] 则是结构化令牌格式的一个示例。这种方法将访问令牌的数据编码并签名，成为 JSON Web 令牌 [[RFC7519](https://www.rfc-editor.org/info/rfc7519)]。

为了让客户端使用访问令牌，可能需要额外的认证凭据，这不在本规范的范围内。这些凭据通常被称为发送者约束的访问令牌，例如 DPoP [[RFC9449](https://www.rfc-editor.org/info/rfc9449)] 和 mTLS [[RFC8705](https://www.rfc-editor.org/info/rfc8705)]。

访问令牌提供了一层抽象，用资源服务器所能理解的单一令牌，替代了各种授权结构（例如用户名和密码）。这种抽象使得颁发的访问令牌能够比用于获取它们的授权许可更有限制性，并且消除了资源服务器理解多种认证方法的需要。

根据资源服务器的安全要求，访问令牌可以采用不同的格式、结构以及使用方法（例如加密属性）。访问令牌的属性，以及用于访问受保护资源的方法，可以在本规范之外进行延申。

访问令牌（以及访问令牌的任何机密属性）**必须**在传输和存储时保持机密，并且只能在授权服务器、该访问令牌对其有效的资源服务器和该访问令牌被颁发给的客户端之间共享。

授权服务器**必须**保证访问令牌无法被未授权方生成、修改或者猜中，并以此创建有效的访问令牌。

## 1.4.1. 访问令牌的范围

被颁发访问令牌的客户端，相比起授予它访问权限的用户来说，权限更少。这种令牌被称为有限“范围”的访问令牌。授权服务器和资源服务器可以使用这种范围机制来限制某一客户端可以访问的资源类型或访问级别。

例如，客户端可能只需要对用户资源的“读取”访问权限，而不需要更新资源。因此，客户端可以请求由授权服务器定义的只读范围，然后获取一个无法用于更新资源的访问令牌。这需要授权服务器、资源服务器和客户端三者的协调。授权服务器提供给客户端请求特定范围的能力，并将这些范围与颁发给客户端的访问令牌关联起来。然后，在面对有限范围的访问令牌时，资源服务器负责执行这些范围限制。

范围的值不由 OAuth 定义，而是由授权服务器，或者 OAuth 扩展或配置文件定义。[[OpenID](https://openid.net/specs/openid-connect-core-1_0.html)] 就是其中一个定义范围的扩展。它定义了一系列范围，提供了对用户资料的细粒度访问权限。建议避免定义与已知扩展中的范围冲突的自定义范围。

为了请求有限范围的访问令牌，客户端根据使用的授权类型，在授权或令牌端点使用范围请求参数。授权服务器则使用范围响应参数，来告知客户端颁发的访问令牌的范围。

范围参数的值表示为以空格分隔的、区分大小写的字符串列表。这些字符串由授权服务器定义。如果值包含多个以空格分隔的字符串，它们的顺序不重要，每个字符串都会将一个额外的访问范围添加到所请求的范围中。

```
scope       = scope-token *( SP scope-token )
scope-token = 1*( %x21 / %x23-5B / %x5D-7E )
```

根据授权服务器的策略或资源所有者的指示，授权服务器**可以**完全或部分忽略客户端请求的范围。如果颁发的访问令牌的范围与客户端请求的范围不同，授权服务器**必须**在令牌响应（第3.2.3节）中包含范围响应参数，以告知客户端实际授予的范围。

如果客户端在请求授权时省略了范围参数，授权服务器**必须**要么使用预定义的默认值处理请求，要么拒绝请求并显示范围无效。授权服务器**应该**记录其范围要求和默认值（如果有定义）。

## 1.4.2. 不记名令牌

不记名令牌是一种安全令牌，持有该令牌的任何一方（“持有者”）都能够以任何其他持有者能够使用该令牌的任何方式来使用该令牌。使用不记名令牌不需要持有者证明其拥有加密密钥材料（持有证明）。

不记名令牌可以使用持有证明规范进行增强，例如 DPoP [[RFC9449](https://www.rfc-editor.org/info/rfc9449)] 和 mTLS [[RFC8705](https://www.rfc-editor.org/info/rfc8705)]，以提供持有证明的特性。

为了防止访问令牌泄露，客户端和资源服务器之间的通信交互**必须**使用第 1.5 节中描述的机密性和完整性保护。

不记名令牌没有特定的结构要求或格式要求。如果不记名令牌是对授权信息的引用，那么这样的引用**必须**对攻击者来说是不可猜测的，例如使用足够长的加密随机字符串。如果不记名令牌使用编码机制，在令牌本身中包含授权信息，那么访问令牌**必须**具有足够的完整性保护，以防止令牌被修改。访问令牌的 JWT 形式 [[RFC9068](https://www.rfc-editor.org/info/rfc9068)] 是访问令牌的编码和签名机制的一个示例。

## 1.4.3. 发送者约束的访问令牌

发送者约束的访问令牌将访问令牌的使用绑定到特定的发送方。该发送方有义务展示其知道某个密钥，作为接收方（例如资源服务器）接受该访问令牌的前置条件。

授权服务器和资源服务器**应该**使用发送者约束的访问令牌的机制，例如 OAuth 持有证明展示（DPoP）[[RFC9449](https://www.rfc-editor.org/info/rfc9449)] 或 OAuth 2.0 的双向 TLS（mTLS）[[RFC8705](https://www.rfc-editor.org/info/rfc8705)]。请参考 [[I-D.ietf-oauth-security-topics](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-24)] 的第 4.10.1 节，以防止被盗和泄露的访问令牌的滥用。

**建议**在客户端和资源服务器之间使用端到端的 TLS。如果需要在中间代理处终止 TLS流量，请参考 [[I-D.ietf-oauth-security-topics](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-24)] 的第 4.13 节获取更多安全建议。
