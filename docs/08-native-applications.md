**目录**

- [8. 原生应用](#8-原生应用)
  - [8.1. 原生应用注册](#81-原生应用注册)
    - [8.1.1. 原生应用的客户端认证](#811-原生应用的客户端认证)
  - [8.2. 在原生应用中使用应用间 URI 通信实现 OAuth](#82-在原生应用中使用应用间-uri-通信实现-oauth)
  - [8.3. 从原生应用发起授权请求](#83-从原生应用发起授权请求)
  - [8.4. 在原生应用中接收授权响应](#84-在原生应用中接收授权响应)
    - [8.4.1. 接管 https 协议 URI 重定向](#841-接管-https-协议-uri-重定向)
    - [8.4.2. 回环接口重定向](#842-回环接口重定向)
    - [8.4.3. 私用 URI 方案重定向](#843-私用-uri-方案重定向)
  - [8.5. 原生应用的安全考量](#85-原生应用的安全考量)
    - [8.5.1. 原生应用的嵌入式用户代理](#851-原生应用的嵌入式用户代理)
    - [8.5.2. 原生应用的虚假外部用户代理](#852-原生应用的虚假外部用户代理)
    - [8.5.3. 原生应用的恶意外部用户代理](#853-原生应用的恶意外部用户代理)
    - [8.5.4. 原生应用的回环重定向考量](#854-原生应用的回环重定向考量)

# 8. 原生应用

原生应用是在资源所有者使用的设备上安装和运行的客户端（即桌面端应用和移动端应用）。原生应用需要特别考虑安全性、平台功能和终端用户的整体体验。

授权端点需要客户端与资源所有者的用户代理交互。当前的最佳实践是，在外部用户代理（通常是浏览器），而不是嵌入式用户代理（例如使用 Web View 实现的用户代理）中，进行 OAuth 授权请求。

原生应用可以使用重定向 URI 捕获授权服务器的响应。该重定向 URI 采用的方案是在操作系统中注册以调用客户端作为处理程序、手动复制粘贴凭据、运行本地网络服务器、安装用户代理扩展，或者提供重定向 URI 以识别由客户端控制的服务器资源，进而将响应提供给原生应用。

以前，原生应用经常使用嵌入式用户代理（通常使用 Web View 实现）处理 OAuth 授权请求。这种方法有很多缺点，包括主机上的应用可以复制用户凭据和 cookies，以及用户需要在每个应用中从头开始验证。有关使用嵌入式用户代理实现 OAuth 的缺点的深入分析，见第 8.5.1 节。

使用系统浏览器的原生应用授权请求更安全，而且可以利用设备上的用户认证状态。使用浏览器中现有的认证会话可实现单点登录，因为用户无需在每次使用新应用时都与授权服务器进行认证（除非授权服务器的策略要求这样做）。

即使不更改 OAuth 协议本身，也能够支持原生应用和浏览器之间的授权流程，因为 OAuth 授权的请求和响应已经以 URI 的形式定义，其中包括用于应用间通信的 URI。有些 OAuth 服务器的实现假定了所有客户端都是机密的网络客户端，这些服务器需要进一步了解公共的原生应用客户端，以及它们使用的重定向 URI 的类型，以支持这一最佳实践。

## 8.1. 原生应用注册

除非使用类似于客户端动态注册的机制，以提供实例特定的密钥，否则原生应用都被分类为公共客户端，如第 2.1 节所定义。它们**必须**作为这种类型，与授权服务器进行注册。授权服务器**必须**在客户端注册细节中记录客户端类型，以便依此识别并处理请求。

### 8.1.1. 原生应用的客户端认证

被静态包含在分发给多位用户的应用中的密钥，不应该被视为机密密钥，因为用户可以检查他的那份副本，以获取这一共享密钥。因此，**不建议**授权服务器要求公共原生应用客户端使用共享密钥进行客户端认证，因为除了识别出客户端以外，这样做的意义不大，更何况 client_id 请求参数已经提供了识别依据。

如果授权服务器仍然需要在原生应用客户端中静态包含共享密钥，那么它**必须**将客户端视为公共客户端（如第 2.1 节所定义），并且**禁止**将密钥作为客户端身份的证明。在不采取额外措施的情况下，这种客户端容易受到客户端冒充的攻击（见第 7.3.1 节）。

## 8.2. 在原生应用中使用应用间 URI 通信实现 OAuth

就像网络 OAuth 使用 URI 发起授权请求，并向发起请求的网站返回授权响应一样，原生应用也可以使用 URI，在设备的浏览器上发起授权请求，并向发起请求的原生应用返回授权响应。

通过采用与网络 OAuth 相同的方法，原生应用环境可以获得和网络环境一样的好处，例如可以使用单点登录会话，以及独立认证环境的安全性。重用相同的方法还可以降低实现的复杂度，并且通过依赖基于标准的、平台无关的网络流程，提高互操作性。

原生应用**必须**使用外部用户代理，以进行 OAuth 授权请求。要实现这一点，可以在浏览器中发起授权请求（详见第 8.3 节），然后使用重定向 URI，将授权响应返回给原生应用（在第 8.4 节中定义）。

## 8.3. 从原生应用发起授权请求

当原生应用需要用户授权时，它就创建一个授权请求的 URI，其中包含第 4.1 节中的授权码许可类型，以及能被原生应用接收到的重定向 URI。

原生应用授权请求的重定向 URI 的功能与网络授权请求类似。不过，原生应用的重定向 URI 不是将授权响应返回给 OAuth 客户端的服务器，而是将响应返回给应用。第 8.4 节记录了在不同平台上，向原生应用返回授权响应的几种重定向 URI。只要应用能接收到 URI，并检查其参数，任何重定向 URI 都是可行的。

在构建授权请求 URI 后，应用使用平台特定的 API，在外部用户代理中打开 URI。这一外部用户代理通常是默认浏览器，即系统中配置为处理 http 和 https 协议的 URI 的应用。不过，也**可以**采用另外的浏览器选择标准，或者使用其它类别的外部用户代理。

该最佳实践侧重于将浏览器作为原生应用的**建议**外部用户代理。不过，如果有一款外部应用代理，专为用户授权设计，并且能够像浏览器一样处理授权请求和响应，那么也**可以**使用它。其它的外部用户代理，例如授权服务器提供的原生应用，可能符合该最佳实践中规定的标准，包括使用相同的重定向 URI 属性，但它们的使用超出了该规范的范围。

某些平台支持一种称为“应用内浏览器标签”的浏览器功能。在该功能中，应用可以在应用环境中展示浏览器标签，无需切换应用，但仍然保留了浏览器的关键优势，例如共享认证状态和安全环境。在支持这种功能的平台上，出于可用性的考量，**建议**应用使用应用内浏览器标签，处理授权请求。

## 8.4. 在原生应用中接收授权响应

为了从浏览器处接收到授权响应，原生应用可以使用若干种重定向 URI。它们的可用性和用户体验因平台而异。

### 8.4.1. 接管 https 协议 URI 重定向

在某些操作系统上，应用能够在它们控制的域名下，接管 https 协议的 URI（见 [[RFC9110](https://www.rfc-editor.org/info/rfc9110)] 第 4.2.2 节）。当浏览器遇到被接管的 URI 时，它不会加载这张页面。相对地，原生应用则会启动，并将该 URI 作为一个启动参数。

原生应用可以将这种 URI 作为重定向 URI。对于授权服务器而言，这些 URI 与常规的网络客户端重定向 URI 并无区别。下面是一个示例：

```
https://app.example.com/oauth2redirect/example-provider
```

由于仅靠重定向 URI 无法区分公共原生应用和机密网络客户端，第 8.1 节规定了一项**必需**的操作：在客户端注册过程中，记录客户端类型，以便服务器确定客户端类型，并依此行动。

相比起其它的原生应用重定向方法，应用接管的 https 协议重定向 URI 有一定的优势：操作系统能够向授权服务器保证目标应用的身份。因此，在可能的情况下，原生应用**应该**使用该方法，而不是其它方法。

### 8.4.2. 回环接口重定向

如果原生应用能够在回环网络接口上打开端口，并且不需要特殊权限（通常是桌面端操作系统上的特殊权限），那么它们可以使用回环接口接收 OAuth 重定向。

回环重定向 URI 使用 http 方案，并且由回环 IP 和客户端正在监听的端口组成。

即，对于 IPv4 是 `http://127.0.0.1:{端口}/{路径}`，对于 IPv6 是 `http://[::1]:{端口}/{路径}`。下面是一个示例，使用了 IPv4 回环接口，以及一个随机分配的端口：

```
http://127.0.0.1:51004/oauth2redirect/example-provider
```

下面是一个示例，使用了 IPv6 回环接口，以及一个随机分配的端口：

```
http://[::1]:61023/oauth2redirect/example-provider
```

虽然使用 localhost 的重定向 URI 与回环 IP 重定向的工作方式类似，但是**不建议**使用 localhost。相比起 localhost，使用回环 IP 指定重定向 URI 避免了无意中监听回环接口以外的网络接口。这样也更不容易受到客户端防火墙和用户设备上配置错误的主机名解析的影响。

当申请回环 IP 重定向 URI 时，授权服务器**必须**允许任何端口被指定，以满足客户端从操作系统处获取临时可用端口的需要。

客户端**不应该**假定设备支持互联网协议的某一特定版本。**建议**客户端尝试同时使用 IPv4 和 IPv6 绑定回环接口。

### 8.4.3. 私用 URI 方案重定向

移动端和桌面端的许多计算平台都允许应用注册私用 URI 方案（有时俗称为“自定义 URL 方案”），例如 com.example.app，从而支持通过 URI 进行应用间通信。当浏览器或其它应用程序尝试加载私用 URI 方案的 URI 时，注册其的应用程序将被启动，以处理请求。

支持私用 URI 方案的许多环境都没有提供一种机制，来声明方案，并防止不同应用的方案冲突。因此，使用私用 URI 方案的客户端容易受到针对其重定向 URI 的潜在攻击。所以，只有当无法使用前面提到的、更安全的方法时，才应该使用该方法。

为了使用私用 URI 方案重定向进行授权请求，原生应用启动浏览器，提供标准的授权请求，但其中的重定向 URI 会利用它在操作系统中注册的私用 URI 方案。

当选择与应用关联的 URI 方案时，应用**必须**使用基于由其控制的域名的 URI 方案，并以相反顺序表示，如 [[RFC7595](https://www.rfc-editor.org/info/rfc7595)] 第 3.8 节关于私有 URI 方案的建议。

例如，控制域名 app.example.com 的应用程序可以使用 com.example.app 作为其方案。某些授权服务器会根据域名分配客户端标识符，例如 client1234.usercontent.example.net。如果以同样的方式反转，它也可以用作方案的域名。但是，某些方案，例如 myapp，不符合这一要求，因为它不基于域名。

当同一位发布者发布多个应用时，必须注意每个方案在该组中都是唯一的。在使用基于反序域名的应用标识符的平台上，可以重复使用这些标识符，作为 OAuth 重定向的私用 URI 方案，以帮助避免这一问题。

根据 [[RFC3986](https://www.rfc-editor.org/info/rfc3986)] 第 3.2 节的要求，由于私用 URI 方案重定向没有命名权威，方案组件后只出现一条斜线（/）。下面是一个完整的重定向 URI 示例，利用了私用 URI 方案：

```
com.example.app:/oauth2redirect/example-provider
```

在授权服务器完成请求后，它像通常一样，重定向到客户端的重定向 URI。由于重定向 URI 使用了私用 URI 方案，操作系统就会启动原生应用，并将 URI 作为启动参数传入。然后，原生应用对授权响应进行正常处理。

## 8.5. 原生应用的安全考量

### 8.5.1. 原生应用的嵌入式用户代理

嵌入式用户代理是一种在技术上可行的方法，用于授权原生应用。根据定义，对于授权服务器而言，第三方使用这些嵌入式用户代理是不安全的，因为托管嵌入式用户代理的应用可以访问用户的所有认证凭据，而不只是针对该应用的 OAuth 授权许可。

在典型的、基于网络视图的嵌入式用户代理实现中，主机应用可以记录登录表单中的每个按键输入，以获取用户名和密码、自动提交表单以绕过用户同意，以及复制会话 cookies，并使用其冒充用户进行认证。

即使是由与授权服务器属于同一方的可信应用使用，嵌入式用户代理也违反了最少特权原则，因为它们可以访问比其所需更强大的凭据，从而可能增加攻击面。

如果鼓励用户在嵌入式用户代理中输入凭据，并且没有浏览器通常拥有的地址栏和可见的证书验证功能，那么用户就不可能知道自己是否在登录合法网站。即使知道了，这也会让用户认为不先验证网站就输入凭据是没问题的。

除了安全问题，嵌入式用户代理还不与其它应用或浏览器共享认证状态。这就要求用户在每次授权请求时都要登录，而这通常被认为是一种差劲的用户体验。

### 8.5.2. 原生应用的虚假外部用户代理

发起授权请求的原生应用对用户界面有很大的控制权，并且可能展示虚假外部用户代理，即伪装成外部用户代理的嵌入式用户代理。

当所有善意参与者都使用外部用户代理时，好处是安全专家有可能发现恶意参与者，因为任何伪造外部用户代理的人都可以被证明是坏人。另一方面，如果善意参与者和恶意参与者都使用嵌入式用户代理，那么恶意参与者就不需要伪造任何东西，从而更难被发现。一旦检测到恶意应用，这些知识就可能被用于在恶意软件扫描软件中，将该恶意应用的签名列入黑名单，并采取删除措施（如果是应用商店分发的应用）和其它措施，以减少恶意应用的影响和传播。

授权服务器还可以要求使用只有真正的外部用户代理才能使用的认证因素，以直接防止虚假外部用户代理。

如果用户在使用应用内浏览器标签时，特别关注自己的安全，那么他们也可以采取额外的步骤，从应用内浏览器标签打开完整浏览器，再在后者中打开请求并完成授权，因为大多数应用内浏览器标签模式的实现都提供了这种功能。

### 8.5.3. 原生应用的恶意外部用户代理

如果恶意应用能够将自己配置为操作系统中 https 协议 URI 的默认处理程序，它就能够拦截使用默认浏览器的授权请求，并滥用这种信任地位，以达到恶意目的，例如对用户进行钓鱼。

这种攻击不只局限于 OAuth。如此配置的恶意应用会给用户带来原生应用使用 OAuth 以外的、普遍而持续的风险。许多操作系统会要求用户明确更改 http 和 https 协议 URI 的默认处理程序，以减轻这一问题。

### 8.5.4. 原生应用的回环重定向考量

回环接口重定向 URI **可以** 使用 http 协议（即不使用 TLS）。由于 HTTP 请求从不离开设备，对于回环接口重定向 URI 而言，这是可以接受的。

只在发起授权请求时，客户端才应该打开网络端口。一旦响应返回，客户端就应该关闭网络端口。

客户端应该只监听回环网络接口，以避免其它网络参与者的干扰。

客户端应该使用回环 IP，而不是如第 8.4.2 节所述的字符串 localhost。
